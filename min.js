class DataTable{constructor(t,e){this.id=t,this.columns=e}transform(t){let e=[];return t.forEach(t=>{e[t.url_id]||(e[t.url_id]={domain:t.domain,origin_url:t.origin_url,url:t.url,language:t.language,code_search:"",queries:[]}),""===e[t.url_id].code_search?e[t.url_id].code_search=t.code_search:e[t.url_id].code_search!==t.code_search&&(e[t.url_id].code_search="BOTH"),e[t.url_id].queries.push(`${t.query} (${t.rank})`)}),e.sort(function(t,e){return e.queries.length-t.queries.length}),e.filter(t=>!!t.domain)}update(t){t=this.transform(t);d3.select(this.id).selectAll("tr").data(t).join("tr").selectAll("td").data(e=>this.columns.map(t=>{switch(t){case"queries":return`<ul><li>${e[t].join("</li><li>")}</li></ul>`;case"url":return`<a href='${e.origin_url}' title='${e[t]}' target='_blank'><div class='url'>${e[t]}</div></a>`;default:return e[t]}})).join("td").html(t=>t)}}class Histogram{constructor(t,e,r){this.id=t,this.width=e,this.height=r}transform(t){let a=t.links.map(t=>new Set([t.source,t.target]));for(;;){var e=a.length;for(let t=0;t<e;++t){let r=a.shift();a.some((t,e)=>{if(0<[...t].filter(t=>r.has(t)).length)return r=new Set([...t,...r]),a.splice(e,1),a.push(r),!0})||a.push(r)}if(e===a.length)break}return a.sort(function(t,e){return e.size-t.size}),a}update(r){var t=this.transform(r),e=d3.select(this.id);e.html("");let a=30;var i=this.width-60,n=this.height-60,s=i/t.length;let o=d3.scaleLinear().domain([0,t.length]).range([0,i]),l=(e.append("g").attr("transform",`translate(30, ${n+a})`).call(d3.axisBottom(o).ticks(Math.min(10,t.length))),d3.max(t,t=>t.size)),d=d3.scaleLinear().domain([0,l]).range([n,0]);e.append("g").attr("transform","translate(30, 30)").call(d3.axisLeft(d).ticks(Math.min(10,l)));i=e.selectAll("rect").data(t).join("rect");i.transition().attr("transform",(t,e)=>`translate(${o(e)+a}, ${d(t.size)+a})`).attr("width",s).attr("height",t=>d(l-t.size)).style("fill",color(.7)),i.append("title").text(t=>[...t].map(t=>{for(var e in r.nodes)if(r.nodes[e].id===t)return`${r.nodes[e].text} (rank: ${r.nodes[e].rank})`}).join("\n"))}}class Network{constructor(t,e,r){this.id=t,this.width=e,this.height=r}transform(t){let a={nodes:[],links:[]},i={},n={};for(var e in t.forEach(t=>{var e="u_"+t.url_id,r=(e in n||(n[e]={}),"q_"+t.query_id);n[e][r]=!0,r in i||(i[r]=!0,a.nodes.push({id:r,text:t.query,rank:t.rank}))}),n){let t="";for(var r in n[e])""===t?t=r:a.links.push({source:t,target:r})}return a}update(t,e,r){var t=this.transform(t),a=d3.select(this.id);a.html("");let i=d3.forceSimulation().force("link",d3.forceLink().distance(5).id(function(t){return t.id})).force("charge",d3.forceManyBody()).force("charge",d3.forceManyBody().strength(-10)).force("center",d3.forceCenter(this.width/2,this.height/2)).force("collision",d3.forceCollide(10).radius(15)),n=a.append("g").attr("class","links").selectAll("line").data(t.links).join("line").attr("stroke-width",2),s=a.append("g").attr("class","nodes").selectAll("g").data(t.nodes).join("g");s.append("circle").attr("r",5).style("fill",t=>r((e-t.rank)/e*.9)).append("title").text(t=>`${t.text} (rank: ${t.rank})`),d3.drag().on("start",function(t,e){i.alphaTarget(.5).restart(),e.fx=e.x,e.fy=e.y}).on("drag",function(t,e){e.fx=t.x,e.fy=t.y}).on("end",function(t,e){e.fx=null,e.fy=null,i.alphaTarget(0)})(s),s.append("text").text(t=>t.text).attr("x",6).attr("y",2).append("title").text(t=>`${t.text} (rank: ${t.rank})`),i.nodes(t.nodes).on("tick",function(){function e(t){return Math.max(0,Math.min(950,t))}function r(t){return Math.max(0,Math.min(500,t))}n.attr("x1",t=>e(t.source.x)).attr("y1",t=>r(t.source.y)).attr("x2",t=>e(t.target.x)).attr("y2",t=>r(t.target.y)),s.attr("transform",t=>`translate(${e(t.x)},${r(t.y)})`)}),i.force("link").links(t.links)}}class PieChart{constructor(t){this.id=t,this.tooltip=d3.select("#pie_tooltip")}transform(t){let r={},a=0;t.forEach(t=>{let e=t.domain;0==e.indexOf("www.")&&(e=e.slice(4)),r[e]||(r[e]=0),++r[e],++a});var e,i=[];for(e in r)i.push({text:e,size:r[e],rate:(r[e]/a*100).toFixed(1)});return i.sort(function(t,e){return e.size-t.size}),i.splice(10),i}update(t){var t=this.transform(t),e=(d3.select(this.id).html(""),d3.pie().value(t=>t.size)),t=e(t),t=d3.select(this.id).append("g").attr("transform","translate(250, 250)").selectAll("g").data(t).join("g"),r=t.append("path").attr("class","pie_node").style("fill",(t,e)=>d3.schemeCategory10[e%10]).on("mouseover",()=>{this.tooltip.style("opacity",1)}).on("mousemove",(t,e)=>{this.tooltip.html(`
                    Domain: <strong>${e.data.text}</strong><br>
                    Count: <strong>${e.data.size}</strong><br>
                    Rate: <strong>${e.data.rate}%</strong>
                `).style("left",t.pageX+20+"px").style("top",t.pageY+"px")}).on("mouseleave",()=>{this.tooltip.style("opacity",0)});let a=d3.interpolate(e.startAngle()(),e.endAngle()()),i=d3.interpolate(0,0),n=d3.interpolate(0,180),s=d3.arc();r.transition().duration(2500).attrTween("d",e=>{let r=e.endAngle;return t=>{t=a(t);return t<e.startAngle?"":(e.endAngle=Math.min(t,r),s(e))}}),d3.select(this.id).transition().duration(2500).tween("arcRadii",()=>t=>s.innerRadius(i(t)).outerRadius(n(t)));var o=d3.arc().outerRadius(300).innerRadius(100);t.append("text").text(t=>t.data.text).attr("transform",t=>`translate(${o.centroid(t)})`).attr("font-family","impact").attr("font-size","16px").attr("text-anchor","middle").style("fill",(t,e)=>d3.schemeCategory10[e%10]).style("text-shadow","-1px 0px #fff, 0px 1px #fff, 1px 0px #fff, 0px -1px #fff")}}class WordCloud{constructor(t,e,r,a){this.id=t,this.width=e,this.height=r,this.hide_words=a}transform(t){let e={};t.forEach(t=>{t.query.split(" ").forEach(t=>{this.hide_words.includes(t)||(e[t]||(e[t]=0),++e[t])})});var r,a=[];for(r in e)a.push({text:r,size:e[r]});return a}draw(t){d3.select("#word_cloud").append("g").attr("transform","translate(250, 250)").selectAll("text").data(t).join("text").transition().style("font-size",t=>t.size+"px").style("font-family","Impact").style("fill",(t,e)=>d3.schemeCategory10[e%10]).attr("text-anchor","middle").attr("transform",t=>`translate(${t.x}, ${t.y}) rotate(${t.rotate})`).text(t=>t.text)}update(t){d3.select(this.id).html("");t=this.transform(t);let e=d3.scaleLinear().domain([1,d3.max(t,t=>t.size)]).range([10,90]);d3.layout.cloud().size([this.width,this.height]).words(t.map(t=>({text:t.text,size:e(t.size)}))).padding(1).rotate(()=>90*~~(2*Math.random())).font("Impact").fontSize(t=>t.size).on("end",this.draw).start()}}